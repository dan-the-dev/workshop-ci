#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

npm run lint

echo "Starting dev server and json-server in background..."

# Start both servers in the background
npm run dev &  
DEV_PID=$!  

npm run json-server &  
JSON_SERVER_PID=$!  

# Wait for servers to be ready (modify this according to your needs)
echo "Waiting for servers to start..."
sleep 5  

# Run Playwright tests
echo "Running Playwright tests..."
npm run test  

# Capture test exit code
TEST_EXIT_CODE=$?  

# Stop background processes
echo "Freeing ports: Dev:$DEV_PID ..."
  
  DEV_PORT=$(lsof -Pan -p $DEV_PID -i | awk 'NR>1 {print $9}' | cut -d':' -f2 | head -n1)
  while lsof -ti :$DEV_PORT > /dev/null; do
    echo "Port $DEV_PORT is in use by process $DEV_PID. Killing it..."
    kill -9 $DEV_PID
    sleep 1  # Wait a moment before checking again
  done
  echo "Dev port $DEV_PORT is now free!"
  
echo "Freeing ports: JSON-SERVER:$JSON_SERVER_PID ..."
  
  JSON_SERVER_PORT=$(lsof -Pan -p $JSON_SERVER_PID -i | awk 'NR>1 {print $9}' | cut -d':' -f2 | head -n1)
  while lsof -ti :$JSON_SERVER_PORT > /dev/null; do
    echo "Port $JSON_SERVER_PORT is in use by process $JSON_SERVER_PID. Killing it..."
    kill -9 $JSON_SERVER_PID
    sleep 1  # Wait a moment before checking again
  done
  echo "JSON-SERVER port $JSON_SERVER_PORT is now free!"

echo "Finished!"
exit $TEST_EXIT_CODE
